<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>TeenAstro V2 - TeenAstro V3</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "TeenAstro V2";
        var mkdocs_page_input_path = "teenastro_v2.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> TeenAstro V3
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="./">TeenAstro V2</a>
    <ul class="current">
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../teenastro_v3/">TeenAstro V3</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">TeenAstro V3</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" alt="Docs"></a> &raquo;</li>
      <li>TeenAstro V2</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h2 id="introduction">Introduction</h2>
<p>This is a description of the TeenAstro software. It consists of 2 main parts, the Main Unit and the SHC (Smart Hand Controller).   </p>
<h2 id="main-unit">Main Unit</h2>
<p>The current design (2022) Main Unit runs on a Teensy 3.2 board. This is based on an ARM Cortex M4 processor, with peripherals (UART, timer, SPI, etc.). The stepper controllers are TMC2130 or TMC2160 from Trinamic in STEP/DIR mode.   </p>
<p>The software is built with the Arduino framework (setup / loop) and consists of 3 main parts: the Main Loop, the Timer Loop and the Motor Interrupts.  Without an operating system, it relies on global variables. To prevent concurrent variable accesses between the 3 contexts, it disables interrupts (cli / sei).</p>
<h3 id="main-loop">Main Loop</h3>
<p>The Main loop runs every 10mS (sidereal). It polls for commands from both UARTs (SHC and USB), which handle identical commands based on the LX200 standard (Goto, track, guide etc) with proprietary extensions. It computes the positions and speeds of both axes, then checks for safety limits.   </p>
<h4 id="positioning-mode-goto">Positioning Mode (Goto)</h4>
<p>Much of the code is common between Eq and Altaz mounts. </p>
<p>The simplified call sequence for a Goto RA/Dec command is as follows:</p>
<pre><code>GotoEqu(HA, Dec)                    // LX200 command
    EquToHor(HA, Dec)               // computes target Az/Alt
    goToHor(Az, Alt)                // can also be called directly by LX200 command 
        toInstrumentalDeg(Az, Alt)  // matrix operation that computes axes positions as floating-point degrees
        predictTarget()             // converts degrees to steps (long integers), taking into account the gear ratio
            Angle2InsrtAngle        // corrects positions according to pier side if needed
        Goto(Axis1, Axis2)          // check for errors, then sets targets for both axes
</code></pre>
<p>For retrieving current RA/Dec:</p>
<pre><code>getEqu()                            // LX200 command :GR#, :GD#
    getHorApp()                     // retrieves axis positions in steps and converts to degrees
        toReferenceDeg()            // matrix operation - converts axis degrees to sky Az/Alt 
    HorTopoToEqu()                  // converts Az/Alt to HA/Dec    
</code></pre>
<h4 id="mapping-sky-coordinates-to-axis-angles">Mapping sky coordinates to axis angles</h4>
<p>The difference between Eq and AltAz mounts is handled inside the alignment matrix operations (toInstrumentalDeg / toReferenceDeg) based on <a href="http://takitoshimi.starfree.jp/matrix/matrix_method_rev_e.pdf">Toshimi Taki's 2004 paper</a>. At initialization, the alignment matrix is initialized as follows: <br />
- for AltAz mounts, Axis1 is Azimuth reversed by 180ยบ, Axis2 is Altitude, so that in the Home position the optical tube is horizontal, pointing South. <br />
- for Eq mounts, it converts Axis1/Axis2 to Altitude and Azimuth, so that in the Home position the optical tube points to the celestial pole.   </p>
<p>The idea is to perform all Goto with the same (AltAz) code. <br />
This simplifies somewhat the design, but has several disadvantages: <br />
- It causes problems near the poles, especially for polar alignment software: If we rotate the RA axis when pointing at the pole, the new AltAz position will be identical, since the tube still points at the pole, therefore the reported RA does not change, even though the RA axis has rotated.  <br />
- It hides the amount of conversions going on behind the scenes (see tracking section below)   </p>
<h4 id="mapping-axis-angles-to-steps">Mapping axis angles to steps</h4>
<p>This mapping is not one-to-one: The same position (in steps) may represent 2 different axis angles, according to the hemisphere. This also applies to the direction of tracking.</p>
<p>The motor reverse bit is handled at the very lowest level so that the whole software uses the same coordinates for direct and reverse directions.</p>
<h4 id="slewing-mode">Slewing Mode</h4>
<p>Slewing or centering is triggered by pressing direction keys. It moves the mount at predefined speeds in any direction, without a target. This is the call sequence:</p>
<pre><code>MoveAxis1/2                         // LX200 command
MoveAxis1/2atRate (rate)            // directy sets the motor timers
</code></pre>
<h4 id="tracking">Tracking</h4>
<p>Tracking does not use a fixed velocity for the RA axis, but repeated positioning mode on a moving pseudo-target. For an Eq mount, it goes like this:</p>
<pre><code>computeTrackingRate                     // :Te# LX200 command. This enters the tracking mode called by the main loop:

    do_compensation_calc()              // Computes positions behind and ahead of the current position:
        for each position
            getEqu()                    
                getHorApp()             // retrieves RA/Dec axis positions in steps and converts to degrees
                    toReferenceDeg()    // converts axis degrees to sky Az/Alt - matrix operation  
                horAppToEqu()           // convert Az/Alt to RA/Dec - trig operation 
            equToHor()                  // convert RA/Dec to Az/Alt - trig operation
            toInstrumentalDeg()         // convert Az/Alt to RA/Dec axis degrees - matrix operation
            instrtoStep()               // axis degrees to steps
        compute difference between the 2 axis positions, derive a speed then set the motor timers
</code></pre>
<h4 id="guiding">Guiding</h4>
<p>Guiding for astrophoto is performed either by signals on the ST4 connector emulating button presses, or by software commands.
It increases or decreases the tracking speed on both axes.</p>
<p>The code is somewhat confusing because the term is used both for centering (SHC button presses) and for automatic guiding via software (PHD2 etc.)</p>
<pre><code>enableST4GuideRate()                    // :Mgdnnnn# Pulse guide command
    PerformPulseGuiding()
    apply_GuidingA1()                   // modify the tracking pseudo-target

</code></pre>
<h3 id="timer-loop">Timer Loop</h3>
<p>The timer loop is triggered by a hardware timer that runs every 10mS (sidereal). From the current mode (Goto, track, guide etc.) it computes and programs the periods (rates) for both motor interrupts.  </p>
<h3 id="motor-interrupts">Motor Interrupts</h3>
<p>There is one motor interrupt handler for each axis motor. Each one runs at a period determined by the axis speed and controls the STEP and DIR inputs of the TMC motor controller.  </p>
<h2 id="smart-hand-controller">Smart Hand Controller</h2>
<p>The SHC handles all user interface, as well as the databases for deep-sky objects, and the solar system computations. It is currently implemented on a Wemos processor that includes a Wifi interface. The peripherals are 7 buttons,  a screen controlled by I2C, and a UART connected to the Main Unit. All commands and response follow the LX200 standard, with proprietary additions.</p>
<h2 id="primer-on-mount-design">Primer on Mount Design</h2>
<p>To point any direction in the sky, a telescope mount requires (at least) 2 orthogonal axes. In practice these two types exist:</p>
<ul>
<li>Alt-Az: Primary axis is vertical, secondary axis is horizontal.   </li>
<li>Equatorial: Primary axis points to celestial pole, secondary axis sweeps along a meridian.</li>
</ul>
<p>Within these two main types, there are several design options: <br />
- Fork: Optical tube is in the same plane as the primary axis. <br />
- Offset: Optical tube is offset to the side of the primary axis. Usually requires a counterweight.</p>
<p>Therefore TeenAstro can be configured for any of these 4 types of mounts: </p>
<table>
<thead>
<tr>
<th></th>
<th align="center">Fork</th>
<th align="center">Offset</th>
</tr>
</thead>
<tbody>
<tr>
<td>Alt-Az</td>
<td align="center"><img alt="" src="../altaz_fork.jpg" /><br/>Alt-Az Fork</td>
<td align="center"><img alt="" src="../t.gif" /><br/>Alt-Az T-Mount</td>
</tr>
<tr>
<td>Equatorial</td>
<td align="center"><img alt="" src="../eq_fork.jpg" /><br/>Equatorial Fork</td>
<td align="center"><img alt="" src="../gem.jpg" /><br/>German Equatorial (GEM)</td>
</tr>
</tbody>
</table>
<p>Note that some systems do not fit in any of these categories. For example a Dobson telescope on an equatorial table actually has 3 axes: The primary is a kind of horseshoe (equatorial fork), on which an Alt-Az fork is sitting, but not horizontal. But it works!</p>
<p>Also note these interesting cases: <br />
- at the North or South pole, an Alt-Az mount is also an equatorial <br />
- at the equator, the primary axis of an equatorial mount is horizontal</p>
<h3 id="advantages-of-each-type">Advantages of each type</h3>
<h4 id="equatorial-vs-alt-az">Equatorial vs Alt-Az</h4>
<p>Equatorial mounts follow the sky with only one motor on the right ascension (hour) primary axis. The object always stays in the same orientation, there is no field rotation. In contrast, Alt-Az mounts need two motors to track, and the field rotates during tracking, requiring a derotator to make images.    <br />
Alt-Az mounts are mechanically simpler and lighter. The last large equatorial mount was the 200-inch (5.1m) Hale at Mount Palomar (1949). Modern large telescopes are all Alt-Az.</p>
<h4 id="fork-vs-offset-tube">Fork vs. Offset tube</h4>
<p>Equatorial forks are generally bulky and reserved for large instruments. Alt-Az forks are common for amateur telescopes (especially for Schmidt-Cassegrain with short fat tubes). Most amateur telescopes intended for astrophoto are GEM mounts. </p>
<h3 id="what-it-means-for-the-mount-firmware">What it means for the mount firmware</h3>
<p>The main task of a modern GOTO mount firmware is the computation of <strong>axis positions</strong> from the object's <strong>sky coordinates</strong>. For Alt-Az, the axis positions are the required altitude and azimuth. For Equatorial, the axis positions are the Hour Angle (Local sidereal time - Right Ascension of object) and the object's declination (with a positive or negative sign, depending on the RA axis position) <br />
In both cases the computation is the same for fork or offset mounts, but the <strong>limits</strong> are different. For example, a GEM (German Equatorial) cannot track continuously across the southern sky. It needs to perform a <strong>meridian flip</strong>. Equatorial Fork mounts usually cannot track below the pole.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href=".." class="btn btn-neutral float-left" title="Home"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../teenastro_v3/" class="btn btn-neutral float-right" title="TeenAstro V3">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href=".." style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../teenastro_v3/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>UniversalMainUnit - TeenAstro Linux</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "UniversalMainUnit";
        var mkdocs_page_input_path = "swDesign/UniversalMainUnit.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> TeenAstro Linux
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../linux/">Introduction</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Linux</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../linux/config/">Utilities</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../linux/indi/">INDI driver</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../linux/ekos/">Ekos</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Firmware</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../firmware/">Building the Firmware</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../SmartHandController/">Smart Hand Controller</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../TeenAstroMainUnit/">TeenAstroMainUnit</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">UniversalMainUnit</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#operating-system">Operating system</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#file-formats">File Formats</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#program-structure">Program Structure</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#equatorial-vs-altaz-mounts">Equatorial vs AltAz mounts</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#mapping-sky-coordinates-to-axis-angles">Mapping sky coordinates to axis angles</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#equatorial-mounts">Equatorial Mounts</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#altaz-mounts">AltAz Mounts</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#hardware-abstraction-layer-hal">Hardware Abstraction Layer (HAL)</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#timers">Timers</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#non-volatile-memory">Non-Volatile Memory</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#tracking-and-guiding">Tracking and Guiding</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#sync-and-alignment">Sync and Alignment</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#refraction">Refraction</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#motion-control-spi-only-mode-of-the-5160-stepper-controller">Motion Control (SPI-only) mode of the 5160 stepper controller</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#motor-api">Motor API</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../mountDesign/">Supported Mounts</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../troubleshooting/">Troubleshooting</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Testing</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../testing/auto_test/">autoTest</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../testing/mount_sim/">Mount Simulator</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../testing/teenastro_debug/">Debugging</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">TeenAstro Linux</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
          <li>Firmware &raquo;</li>
      <li class="breadcrumb-item active">UniversalMainUnit</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="universalmainunit">UniversalMainUnit</h1>
<h3 id="introduction">Introduction</h3>
<p>Here are the requirements for this redesign of the TeenAstro Main Unit.</p>
<ul>
<li>Support for multiple processors</li>
<li>Support Step/Dir steppers, MotionControl (SPI-only) steppers, DC servo motors </li>
<li>Encoders: on axis (absolute), on axis (relative), on worm (relative), on motor (relative)</li>
</ul>
<p>The original TeenAstro used a Teensy 3.2 processor.  UniversalMainUnit supports Teensy 4.x, but also the ESP32 family. These newer processors already have ports of FreeRTOS. </p>
<h3 id="operating-system">Operating system</h3>
<p>A real-time OS has many advantages compared to the Arduino setup/loop model, in terms of software portability and readability. FreeRTOS is the de-facto standard for this class of projects, and it is available for both ESP32 and Teensy 4.</p>
<p>I have started this porting project on an ESP32, because it has excellent JTAG debug capability, which Teensy 4.x does not have. However it is simple to rebuild the code for both platforms with simple #ifdef statements and to test it in parallel.  </p>
<h3 id="file-formats">File Formats</h3>
<p>I have removed the funky Arduino .INO format and used standard .h headers and .cpp sources. Much of the code is unchanged, in particular the math calculations. However all low-level code that handles timers and interrupts is new.    </p>
<h3 id="program-structure">Program Structure</h3>
<p>There are now 3 main tasks (Command, Control, Monitor) plus one task for each motor driver (in Step/Drive mode) <br />
  - The Command task handles communication with the 2 serial ports, and does the high-level computation of positions and speeds<br />
  - The Control task contains the logic for the main states of operation (Tracking, Goto)  <br />
  - The Monitor task controls the limits and does general housekeeping <br />
  - The Motor tasks control the motors in Step/Dir mode. (Motion Controller does not require a task since it is very simple and relies on the TMC5160 hardware logic).  <br />
  - The upper-level tasks do all their computations in angles (double floating point), axis positions (32-bit signed integers) and speeds, either in multiples of sidereal speed, or in steps per second (both double floating point).    </p>
<h3 id="equatorial-vs-altaz-mounts">Equatorial vs AltAz mounts</h3>
<p>The original TeenAstroMainUnit uses alignment matrices for 2 purposes:</p>
<ul>
<li>for the  sky model (mapping sky coordinates to instrument coordinates) </li>
<li>to handle the differences between the two kinds of mounts, by considering that an Eq mount is simply an AltAz mount oriented towards the pole. </li>
</ul>
<p>For UniversalMainUnit, the alignment matrix <strong>only maps the sky coordinates</strong> to instrument coordinates, and <strong>all mount-dependent code is isolated in 2 different classes</strong>, one for each type of mount. Each class has its own goto, tracking etc. routines. This way we only test the mount type once at startup, and in most cases we no longer need to call isAltAz() or similar functions at run-time.   </p>
<h3 id="mapping-sky-coordinates-to-axis-angles">Mapping sky coordinates to axis angles</h3>
<h4 id="equatorial-mounts">Equatorial Mounts</h4>
<p>Mapping axis positions to sky coordinates requires careful definitions. <br />
For an equatorial mount, Axis1 is the Hour Angle and Axis2 is the Declination. <br />
A GEM mount in the Home Position points to the pole, with its DEC axis vertical. From this position, the DEC axis can move either clockwise (as seen from the top), in which case it points towards the geographic east, or counterclockwise, to point to geographic west. Following <a href="http://www.bbastrodesigns.com/scopeToSky.html">Mel Bartels, the grand-daddy of telescope mount controllers</a>, we define the home position as Axis2 = zero, the counterclockwise orientation as "direct" (Axis2 &gt; 0, Pier Side=East) and the clockwise orientation as "flipped" (Axis2 &lt; 0, Pier Side=West). We can now plot the following relations between axes and coordinates, for a GEM mount in the northern hemisphere. For the southern hemisphere, both plots are reversed. Note that equatorial forks are different (to be done).</p>
<table>
<thead>
<tr>
<th>ha_direct = axis1+90, ha_flipped=axis1-90</th>
<th>dec = 90+axis2[-90..0], dec=90-axis2[0..90]</th>
</tr>
</thead>
<tbody>
<tr>
<td><img alt="" src="../axis1_ha.png" /></td>
<td><img alt="" src="../axis2_dec.png" /></td>
</tr>
</tbody>
</table>
<h4 id="altaz-mounts">AltAz Mounts</h4>
<p>For AltAz mounts, Axis1 is the azimuth and Axis2 is the altitude. Home position is defined as Alt=0, pointing away from the pole (in the Northern hemisphere: az=180º, alt=0º, in the Southern Hemisphere, az=0º, alt=0º).  We define the Axis1 direction as positive for Clockwise, like the azimuth.</p>
<p><img alt="" src="../axis1_az_n.png" /> <img alt="" src="../axis1_az_s.png" /></p>
<pre><code>
N. Hemisphere   
Azimuth = (Axis1+180) mod 360   
Altitude = Axis2   

S. Hemisphere   
Azimuth = Axis1 mod 360   
Altitude = Axis2   


</code></pre>
<h3 id="hardware-abstraction-layer-hal">Hardware Abstraction Layer (HAL)</h3>
<p>The Arduino framework and libraries already provide most of the abstraction layer (UART, SPI etc.), but some functionality still requires #ifdef in the code. This includes:   </p>
<ul>
<li>Chip-specific code</li>
<li>chip reset </li>
<li>programming hardware timers</li>
<li>installing and running interrupt service routines (ISR)</li>
<li>non-volatile memory</li>
<li>Board-specific code</li>
<li>Pin definitions and multiplexing</li>
<li>other peripherals on the PCB (real-time clock) </li>
</ul>
<p>Until now, we have been inserting #ifdef statements throughout the code, which is not very readable or portable. A better solution would be an abstraction layer that encapsulates all chip and board-specific code like this:</p>
<pre><code>HAL.h
#ifdef BOARD_240        // the current TeenAstro board
#include teensy_3_2.h   
#include board_240.h    
#endif

#ifdef BOARD_250        // Teensy 4 board
#include teensy_4_0.h   
#include board_250.h    
#endif

#ifdef BOARD_ESP32      // ESP32 board
#include esp32_s3.h         
#include board_esp32.h  
#endif
</code></pre>
<pre><code>teensy_3_2.h
#define ISR(f)  void f(void)

void beginTimers(void)
{
  ...
}
</code></pre>
<pre><code>esp32_s3.h
#define ISR(f) void IRAM_ATTR f(void) 

hw_timer_t *timerP = NULL;

void beginTimers(void)
{
  ...
}
</code></pre>
<h3 id="timers">Timers</h3>
<p>The ISR running off the sidereal timer has only one purpose, which is to update the sidereal time. All other tasks run at multiples of the operating system's tick, normally one millisecond.   </p>
<h3 id="non-volatile-memory">Non-Volatile Memory</h3>
<p>On ESP32 there is no EEPROM, but a section of RAM that emulates EEPROM, and gets written into the Flash with the EEPROM.commit() function. To keep the code compatible, the Monitor task performs a hash of the RAM (every 10 seconds or so) and commits it to Flash when a change is detected.   </p>
<h3 id="tracking-and-guiding">Tracking and Guiding</h3>
<p>While tracking, the Control Task periodically computes the tracking speed. For Eq Mounts, this is currently a constant (it will eventually add components for refraction), for Altaz mounts, it is the difference between computed positions slightly before and after the current position.
If required, it adds increments corresponding to guiding commands (pulse or ST4), or spiral.</p>
<h3 id="sync-and-alignment">Sync and Alignment</h3>
<p>Synchronizing the mount, or 1-star alignment, is simply resetting the instrument coordinates to a known value (Home, or a given star). <br />
2-star alignment consists of setting up a linear relationship between: <br />
- reference coordinates (Hour Angle and Declination) of 2 stars and <br />
- instrument coordinates (the positions of the 2 axes).  <br />
We use <a href="http://takitoshimi.starfree.jp/">Toshimi Taki's</a> matrix method.</p>
<h3 id="refraction">Refraction</h3>
<p>Not yet implemented</p>
<h3 id="motion-control-spi-only-mode-of-the-5160-stepper-controller">Motion Control (SPI-only) mode of the 5160 stepper controller</h3>
<p>The TeenAstrov2 code base uses the STEP/DIR mode for controlling the stepper motor driver (TMC2130 or TMC5160). This requires the microcontroller to toggle the STEP input of the driver for each step. Since we use microstepping to get a smooth motion, we program one interrupt for each microstep. The interrupt period is </p>
<pre><code>t = 24 * 3600 / (gear reduction * steps/rot * microsteps)
</code></pre>
<p>For example, for a gear reduction of 1000 (ratio of motor axis to mount axis rotations), typical motors with 200 steps/rotation, 32 microsteps, and sidereal rate (one mount axis rotation for 24 hours), our interrupt period is:  </p>
<pre><code>t = 24 * 3600 / (1000 * 200 * 32) = 13.5mS.
</code></pre>
<p>At higher slew speeds, the interrupt period is reduced proportionally: at a slew speed of 100x, the period is 13.5mS / 100 = 135µS.   </p>
<p>In turn, the minimum interrupt period of the microcontroller limits the maximum slew speed. (to 675x in our example for the Teensy 3.2).      </p>
<p>The corresponding step size for the motor axis is 360º / (gear reduction * steps/rot * microsteps). In our example, the step size is 360 / (1000 * 200 * 32) = 0.000056º = 0.2" (arc-seconds). This step size should be kept as low as possible to ensure smooth tracking and guiding.   </p>
<p>The Trinamic 5160 can run without STEP/DIR interrupts and can control the motor directly through the SPI without requiring a microcontroller interrupt at each step. </p>
<p>Therefore we can use the highest possible microstep value (256) and the highest slew rate that the motors can handle. (We are only limited by the maximum torque).   </p>
<h3 id="motor-api">Motor API</h3>
<p>All the motor functionality is accessed through this API. The device driver for each type of motor (Step/Dir, MotionControl, Servo) implements these functions.    </p>
<pre><code>class MotionControl   
{   
public:   
  virtual void setCurrentPos(long);   
  virtual void setTargetPos(long);   
  virtual void syncPos(long);   
  virtual void setVmax(double);   
  virtual void setAmax(long);   
  virtual long getCurrentPos(void);   
  virtual long getTargetPos(void);   
  virtual double getSpeed(void);   
  virtual bool positionReached(void);   
  virtual bool isMoving(void);   
  virtual void abort(void);   
  virtual void resetAbort(void);   
  virtual void initStepDir(int DirPin, int StepPin, void (*isrP)(), unsigned timerId);   
  virtual void initMc5160(TMC5160Stepper *driverP, SemaphoreHandle_t mtx, long);   
  virtual void setRatios(long);   
};   

</code></pre>
<p>For the MotionController mode, we need a 5160 BOB (Breakout Board), or a bigTreeTech 5160. The Watterott SilentStepStick cannot be used, because we need to:   </p>
<ul>
<li>set SD_MODE to GND to use the internal step generator   </li>
<li>connect an external clock to the CLK input. Without this external clock, the precision is +-4%.</li>
</ul>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../TeenAstroMainUnit/" class="btn btn-neutral float-left" title="TeenAstroMainUnit"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../mountDesign/" class="btn btn-neutral float-right" title="Supported Mounts">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../TeenAstroMainUnit/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../mountDesign/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
